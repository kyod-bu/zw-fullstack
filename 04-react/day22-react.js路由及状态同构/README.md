# react-router è·¯ç”±åŠçŠ¶æ€åŒæ„

**æœåŠ¡ç«¯è·¯ç”±ï¼š**

å‘é€è·¯ç”±åˆ°åç«¯ï¼Œè¯·æ±‚èµ„æº/æ•°æ®ï¼ŒæœåŠ¡å™¨æ ¹æ®è¯·æ±‚å†³å®šè¿”å›ç»™ä½ ä»€ä¹ˆä¸œè¥¿

**å®¢æˆ·ç«¯è·¯ç”±ï¼š**

å¹¶ä¸ä¼šå‘é€åˆ°åç«¯å»ï¼Œå½“ url å˜åŒ–æ—¶ï¼Œåœ¨å‰ç«¯å†…éƒ¨è¿›è¡Œå¤„ç†

**åŒºåˆ«ï¼š**

å¯ä»¥çœ‹ Network é‡Œé¢çš„ Doc æ ã€‚

* è·¯ç”±å˜æ›´ï¼ŒDoc æ å˜åŒ–ã€æœåŠ¡ç«¯è·¯ç”±ã€‘------è¯·æ±‚åç«¯èµ„æº
* è·¯ç”±å˜æ›´ï¼ŒDoc æ æ— å˜åŒ–ã€å®¢æˆ·ç«¯è·¯ç”±ã€‘

## å‰ç«¯è·¯ç”±åŸç†åŠè¡¨ç°

å½“æˆ‘ä»¬è¯´å‰ç«¯è·¯ç”±ï¼Œä¹Ÿå°±æ˜¯å®¢æˆ·ç«¯è·¯ç”±æ—¶ï¼Œæ›´å¤šçš„æ˜¯åœ¨è¯´å½“ url å˜åŒ–æ—¶ï¼Œä¸ä¼šä½¿å½“å‰çš„å˜åŒ–è§¦å‘åˆ°åç«¯â½½æ˜¯åœ¨å‰ç«¯å†…éƒ¨å¤„ç†ã€‚

æ—©æœŸçš„æµè§ˆå™¨æˆ‘ä»¬å¯ä»¥ä½¿â½¤ **hash** æ¥åšè·¯ç”±æ ‡è¯†ï¼Œä½¿â½¤ hash çš„å¥½å¤„ä¹Ÿâ¾®å¸¸æ˜æ˜¾ï¼šğŸ‘

* hash æœ‰â¾®å¸¸å¥½çš„å…¼å®¹æ€§ï¼Œâ¼¤éƒ¨åˆ†â½¼æµè§ˆå™¨éƒ½â½€æŒ hash çš„å½¢å¼
* é€šè¿‡ç›‘å¬ onhashchange å¯ä»¥åˆ¤æ–­è·¯ç”±å˜åŒ–ï¼Œä»â½½åˆ¤æ–­éœ€è¦æ¸²æŸ“çš„ç»„ä»¶
* hash é»˜è®¤ä¸ä¼šå‘é€åˆ°åç«¯

HTML5 ä¹‹åæ–°å¢äº† **history** ç›¸å…³çš„ APIï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ pushState å’Œ replaceState æ¥æ§åˆ¶ url çš„å˜åŒ–ï¼ŒåŒæ—¶å¤„ç†ç»„ä»¶çš„å˜åŒ–

* history ç›¸å…³çš„ api æ”¹å˜çš„æ˜¯ url ä¸­çš„ pathnameï¼Œåˆ·æ–°åä¼šå°†è¿™éƒ¨åˆ† url å‘é€åˆ°åç«¯å»

â¼¤éƒ¨åˆ†å‰ç«¯è·¯ç”±é¡¹â½¬éƒ½æ˜¯ä½¿â½¤è¿™ä¸¤ç§â½…å¼ï¼ˆhashã€historyï¼‰æ¥å®ç°ï¼Œè¿™ç±»ä½¿â½¤å‰ç«¯è·¯ç”±çš„åº”â½¤æˆ‘ä»¬å¯ä»¥ç»Ÿç§°ä¸º **spa å•â»šåº”â½¤**ï¼Œå› ä¸ºè¿™ç±»åº”â½¤ä½¿â½¤èµ·æ¥å°±åƒæ˜¯åªæœ‰â¼€ä¸ªâ»šâ¾¯â¼€æ ·ï¼Œåç»­çš„â»šâ¾¯éƒ½åœ¨å‰ç«¯è¿›â¾å†…å®¹åˆ‡æ¢ï¼Œä¸ä¼šæœ‰æœåŠ¡ç«¯è·¯ç”±â»šâ¾¯é—ªåŠ¨çš„æƒ…å†µã€‚

âš ï¸ å®¢æˆ·ç«¯è·¯ç”±çš„ 2 ç§å®ç°æ–¹æ¡ˆï¼šhashã€hisrory

### hash & hisrory åŒºåˆ«

ä¸»è¦é’ˆå¯¹åˆ‡æ¢è·¯ç”±ä¹‹åï¼Œ**åˆ·æ–°**æ“ä½œ

* hashï¼šä¸ä¼šå‘é€åˆ°åç«¯å»ï¼Œåˆ·æ–°é¡µé¢ä¸ä¼šå‘é€åˆ°åç«¯

* historyï¼šåˆ·æ–°é¡µé¢åï¼Œè¿™éƒ¨åˆ† url ä¼šå‘é€åˆ°åç«¯å»

### å¦‚ä½•åˆ¤æ–­åº”è¯¥ä½¿ç”¨å“ªç§æ–¹å¼ï¼Ÿ

âš ï¸ **å…¼å®¹æ€§**è€ƒè™‘

âš ï¸ å¦‚æœéœ€è¦åç«¯æ”¯æŒï¼Œå¿…é¡»ä½¿ç”¨ history è¿™ç§å½¢å¼

## react-router è¯¦è§£

æ ¸å¿ƒï¼šå¯¹ **hash è·¯ç”±** å’Œ **history è·¯ç”±** çš„å°è£…

å‰â¾¯æˆ‘ä»¬è®²è§£äº†è·¯ç”±åŒ¹é…çš„åŸç†ï¼Œå¯¹äº react çš„ react-router æ¥è¯´ï¼Œæˆ‘ä»¬åªæ˜¯éœ€è¦æŠŠå‰â¾¯è®²åˆ°çš„å†…å®¹èåˆè¿›å…·ä½“çš„ä»£ç ï¼Œä¸ºäº†è®©åŒå­¦ä»¬èƒ½æ›´å¥½çš„ç†è§£ï¼Œåœ¨è¿™â¾¥æŠŠä¹‹å‰è®²è§£çš„éƒ¨åˆ†å’Œ react ç»„ä»¶èåˆèµ·æ¥ã€‚

å¯¹äº react-router çš„ä½¿â½¤ï¼Œreact-router ä¸»è¦å®ç°äº†ä¸¤ä¸ªç»„ä»¶ï¼Œâ¼€ä¸ªæ˜¯ `Route` ç»„ä»¶ï¼Œå¦â¼€ä¸ªæ˜¯ `Link` ç»„ä»¶ã€‚

**`Route`** ç»„ä»¶ä¸»è¦æ˜¯å®šä¹‰äº†è§„å®šçš„è·¯ç”±æ¸²æŸ“çš„ç»„ä»¶ï¼Œ**`Link`** ç»„ä»¶ä¸»è¦æ˜¯æ¸²æŸ“çš„ a æ ‡ç­¾è¿›â¾è·³è½¬ã€‚

ä¸»è¦éœ€è¦ä»¥ä¸‹ä¸‰ç‚¹å†…å®¹ï¼š

* Route ç»„ä»¶ç›‘å¬ url æ”¹å˜ï¼Œç¡®å®šæ¸²æŸ“çš„â¼¦ç»„ä»¶
* Link ç»„ä»¶è§¦å‘ url çš„å˜åŒ–

```jsx
export class Route extends React.Component {
  componentWillMount() {
    const unlisten = history.listen((location, action) => {
      console.log('history change listen', location, action);
      this.forceUpdate();
    });
    this.setState({unlisten});
  }
  
  componentWillUnmount() {
    const { unlisten } = this.state;
    unlisten();
  }
  
  render() {
    const { render, path, component: ChildComponent } = this.props;
    const match = matchPath(path);
    const matchResult = match(window.location.pathname);
    
    if (!matchResult) return null;
    
    if (ChildComponent) {
      return (<ChildComponent match= {matchResult} />);
    }
    
    if (render && typeof render === 'function') {
      return render({matchResult});
    }
    
    return null;
  }
}
```

Link ç»„ä»¶ï¼š

```jsx
export class Link extends React.Component {
  handleClick = (e) => {
    const { replace, to } = this.props; 
    e.preventDefault();
    replace ? history.replace(to) : history.push(to);
  }
  
  render() {
    const { to, children } = this.props;
    
    return (
      <a href={to} onClick= {this.handleClick}>{children}</a>
    );
  }
}
```

```js
import React from 'react';
import { createBrowserHistory } from 'history';
import { match as matchPath } from 'path-to-regexp';
const history = createBrowserHistory();
```

æˆ‘ä»¬ä¸»è¦ä½¿â½¤ **history** è¿™ä¸ªåº“ï¼Œæ¥å¯¹æˆ‘ä»¬çš„è·¯ç”±è¿›â¾ç»Ÿâ¼€å°è£…ï¼Œå®ƒçš„å†…éƒ¨å¸®åŠ©æˆ‘ä»¬å¤„ç†äº†ç¬¬â¼€â¼©èŠ‚è®²çš„ä¸‰ç§æƒ…å†µï¼š

* hashHistoryï¼šhash çš„è·¯ç”±
* browserHistoryï¼šæµè§ˆå™¨ HTML5 ä¸­ history çš„è·¯ç”±
* memoryHistoryï¼šå†…å­˜â¾¥â¾ƒâ¼°è®°å½•â¼€ä¸‹è·¯ç”±æƒ…å†µ

åŒæ—¶æˆ‘ä»¬ä¹Ÿä½¿â½¤äº† path-to-regexp è¿™ä¸ªåº“ï¼Œæ¥å¯¹æˆ‘ä»¬çš„è·¯å¾„è¿›â¾å¤„ç†ï¼Œç”±å®ƒæ¥ç¡®è®¤æˆ‘ä»¬å½“å‰çš„è·¯ç”±æ˜¯å¦æ˜¯ç¬¦åˆå®šä¹‰çš„è·¯ç”±æ ¼å¼ã€‚

å¤‡æ³¨ï¼šSwitch ç»„ä»¶ï¼Œè‡ªå·±çœ‹ä¸€ä¸‹ï¼Œå¹¶ä¸æ˜¯é‡ç‚¹ã€‚

### Router-demo

```sh
# åˆå§‹åŒ–ä¸€ä¸ªé¡¹ç›®ï¼šrouter-demo
npx create-react-app router-demo
cd router-demo
yarn start
```

```sh
# å®‰è£…ç¬¬ä¸‰æ–¹åº“ï¼š
# history
# path-to-regexp
yarn add history
yarn add path-to-regexp
```

## æœåŠ¡ç«¯æ¸²æŸ“åŠåŒæ„

å‰â¾¯æˆ‘ä»¬å­¦åˆ°è¿‡ï¼Œå¯¹äºæœåŠ¡ç«¯æ¸²æŸ“å’Œå®¢æˆ·ç«¯æ¸²æŸ“æ¥è¯´ï¼Œè™½ç„¶æœ€ç»ˆæ˜¾ç¤ºâ»šâ¾¯çš„ç»“æœéƒ½ç›¸åŒï¼Œä½†æ˜¯å¯¹äºä¸åŒâ½…å¼æ¥è¯´ï¼Œä»–ä»¬çš„æ¸²æŸ“è¿‡ç¨‹ä¸å°½ç›¸åŒã€‚

react çš„**æœåŠ¡ç«¯æ¸²æŸ“**ç›¸å¯¹æ¥è¯´å°±ç®€å•â¼€äº›ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿â½¤ **ReactDOM åŒ…ä¸­çš„ server éƒ¨åˆ†**æ¨¡å—è¿›â¾å³å¯ï¼Œè¿™â¾¥æˆ‘ä»¬**å¯åŠ¨â¼€ä¸ª node.js æœåŠ¡å™¨**æ¥åšè¿™ä»¶äº‹æƒ…ã€‚

```js
// react-server.js å•çº¯çš„æœåŠ¡ç«¯æ¸²æŸ“
const express = require('express');
const React = require('react');
const ReactDOMServer = require('react-dom/server');

const app = express();
const Component = React.createElement('div', null, 'hello world');

app.get('/', function(req, res){
    const componentStr =  ReactDOMServer.renderToString(Component);
    // console.log('server get /', componentStr);
    res.send(
        `
            <html>
                <body>${componentStr}</body>
            </html>
        `
    );
});

app.listen(8080);

// å¯åŠ¨è¯¥ node æœåŠ¡ï¼š
// node react-server.js
```

åœ¨æ¸²æŸ“çš„ç»“æœä¸­ï¼Œæˆ‘ä»¬èƒ½å¤Ÿçœ‹åˆ° react åœ¨æ ‡ç­¾ä¸­å¢åŠ äº†â¼€äº› hash å€¼ï¼Œä»–çš„ä½œâ½¤æ˜¯åœ¨**å®¢æˆ·ç«¯æ¸²æŸ“**æ—¶ï¼Œå¦‚æœ vdom å¯¹â½çš„ç»“æœä¸ä¹‹ç›¸åŒï¼Œåˆ™ä¸éœ€è¦é€šè¿‡å®¢æˆ·ç«¯â½…æ³•è¿›â¾æŒ‚è½½ï¼Œå‡å°‘å®¢æˆ·ç«¯æ¸²æŸ“æ—¶çš„å‹â¼’ã€‚

### åŒæ„

æˆ‘ä»¬å¯ä»¥ä½¿â½¤å¾ˆå¤šæ¡†æ¶æ¥å®ç°è¿™ç§**åŒæ„**æ•ˆæœï¼Œä¾‹å¦‚ **next.js æ¥è¾¾åˆ°â¼€ä¸ªåŒæ„çš„æ•ˆæœ**ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å®ƒå†…éƒ¨ä¼šä½¿â½¤â¼€äº› server ç«¯çš„å†…å®¹ã€‚æ‰€ä»¥åœ¨å†™æ³•ä¸Šæˆ‘ä»¬éœ€è¦é¢å¤–æ³¨æ„â¼€äº›ã€‚

```jsx
import React from 'react'

export default class extends React.Component {
  // `getInitialProps` ä½œç”¨ï¼šå¯¹åº”ç”¨åˆå§‹å€¼çš„è·å–
  static async getInitialProps({ req }) {
    const userAgent = req ? req.headers['user-agent'] : navigator.userAgent;
    return { userAgent }
  }
  
  render() {
    return (
      <div>
        Hello World {this.props.userAgent}
      </div>
    )
  }
}
```

â½å¦‚è¿™å°±æ˜¯â¼€ä¸ªä½¿â½¤ next è¿â¾çš„ä¾‹â¼¦ï¼Œnext çš„åº”â½¤ä¸­ä¼šæœ‰ `getInitialProps` è¿™ä¸ªâ½…æ³•ï¼Œä»–çš„ä½œâ½¤å°±æ˜¯å¯¹åº”â½¤åˆå§‹å€¼è¿›â¾è·å–ã€‚å½“ç„¶è¿™â¾¥é’ˆå¯¹ä¸åŒçš„ç¯å¢ƒï¼Œè¿™ä¸ª next åº”â½¤çš„â½£å‘½å‘¨æœŸçš„è¡¨ç°ä¹Ÿå®Œå…¨ä¸åŒã€‚

**æœåŠ¡ç«¯**æœ‰çš„å‚æ•°å†…å®¹ï¼š

* req: HTTPè¯·æ±‚å¯¹è±¡
* res: HTTPå“åº”å¯¹è±¡
* pathname: URLä¸­çš„è·¯å¾„éƒ¨åˆ†
* queryï¼šURLä¸­çš„æŸ¥è¯¢å­—ç¬¦ä¸²éƒ¨åˆ†è§£æå‡ºçš„å¯¹è±¡
* errï¼šé”™è¯¯å¯¹è±¡ï¼Œå¦‚æœåœ¨æ¸²æŸ“æ—¶å‘â½£äº†é”™è¯¯

**å®¢æˆ·ç«¯**æ¸²æŸ“æœ‰çš„å‚æ•°å†…å®¹ï¼š

* xhrï¼šXMLHttpRequestå¯¹è±¡ï¼ˆå®¢æˆ·ç«¯æ¸²æŸ“ç‹¬æœ‰ï¼‰
* pathname: URLä¸­çš„è·¯å¾„éƒ¨åˆ†
* queryï¼šURLä¸­çš„æŸ¥è¯¢å­—ç¬¦ä¸²éƒ¨åˆ†è§£æå‡ºçš„å¯¹è±¡
* errï¼šé”™è¯¯å¯¹è±¡ï¼Œå¦‚æœåœ¨æ¸²æŸ“æ—¶å‘â½£äº†é”™è¯¯

æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªâ½…æ³•ä¸­é€šè¿‡åˆ¤æ–­å‚æ•°æ˜¯å¦å­˜åœ¨ï¼Œæ¥**åˆ¤æ–­**å‡ºå½“å‰æ‰§â¾çš„ç¯å¢ƒæ˜¯æœåŠ¡ç«¯è¿˜æ˜¯å®¢æˆ·ç«¯ã€‚

ä½†è¿™æ ·çš„å†™æ³•å¯¹æˆ‘ä»¬çš„åº”â½¤â¼Šä¾µâ½è¾ƒâ¼¤ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦ç›´æ¥æ”¹é€ æˆ‘ä»¬çš„ react åº”â½¤ï¼ŒåæœŸä¹Ÿä¸å¥½è¿ç§»â¾„å…¶ä»–æœåŠ¡ç«¯æ¡†æ¶å»ã€‚

è¿˜æœ‰â¼€äº›æœåŠ¡ç«¯æ¸²æŸ“æ¡†æ¶ä¾‹å¦‚ hypernova ç­‰ç­‰ï¼Œä»–ä»¬ä¼šä½¿â½¤å…¶ä»–â½…å¼è¾¾åˆ°æ¸²æŸ“æœåŠ¡ç«¯ç»„ä»¶çš„â½¬çš„ã€‚æˆ‘ä»¬å¯ä»¥ä¸ä½¿â½¤ next.js çš„å†™æ³•ï¼Œâ½½æ˜¯é‡‡â½¤æ™®é€šç»„ä»¶çš„å†™æ³•æ¥è¾¾åˆ°æœåŠ¡ç«¯æ¸²æŸ“çš„â½¬çš„ã€‚å½“ç„¶ä¹Ÿå¯ä»¥æˆ‘ä»¬â¾ƒâ¼°ç»´æŠ¤â¼€ä¸ª node.js æœåŠ¡æ¥ä½¿â½¤æœ€å•çº¯çš„â½…å¼åšæœåŠ¡ç«¯æ¸²æŸ“ã€‚

ä½†æ˜¯ä½¿â½¤ä¸“â»”çš„ node.js ä¹Ÿæœ‰ä»–çš„ä¼˜åŠ¿ï¼Œâ½å¦‚é»˜è®¤çš„ node cluster åŠ æˆï¼Œéƒ¨åˆ†ä¸“â»”åšæœåŠ¡ç«¯æ¸²æŸ“çš„æ¡†æ¶ä¼šå¯åŠ¨å¤šä¸ª worker æ¥æ‰§â¾ã€‚

æˆ‘ä»¬â½¤â¼€ä¸ªâ¾®å¸¸ç®€å•çš„ä¾‹â¼¦ï¼Œå°±èƒ½è®©â¼¤å®¶æ˜â½©**åŒæ„**çš„æ„ä¹‰ï¼Œä»¥â¼€ä¸ªæ™®é€šçš„éœ€è¦è·å–å†…å®¹çš„â»šâ¾¯ä¸ºä¾‹ï¼Œæ›¾ç»æˆ‘ä»¬çš„ä»£ç ï¼Œæ˜¯ä¼šåœ¨å®¢æˆ·ç«¯ `ComponentDidMount` å‘é€è¯·æ±‚ï¼Œæ¥è·å–è¯·æ±‚ç»“æœï¼Œæœ€ç»ˆå°†ç»“æœæ¸²æŸ“åˆ°â»šâ¾¯ä¸­å»ã€‚æˆ‘ä»¬åœ¨æœåŠ¡ç«¯æŠŠè¿™éƒ¨åˆ†æ•°æ®ç›´æ¥æ³¨â¼Šç»„ä»¶è¾¾åˆ°æ¸²æŸ“çš„â½¬çš„ï¼Œæœ€ç»ˆåªéœ€è¦åœ¨å®¢æˆ·ç«¯è¿›â¾åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°æ¸²æŸ“ï¼Œå³å¯å¾—çŸ¥ã€‚
